import React, { useState, useEffect } from 'react';
import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, LabelList } from 'recharts';
import { TrendingUp, FilePlus2, UploadCloud, AlertCircle } from 'lucide-react';

// This component now shows three charts side-by-side.
// The PapaParse library for parsing is loaded dynamically.

// Initial placeholder data (will be replaced by uploaded data)
const initialTicketData = [
    { id: 12, status: 'Ready To Test', system: 'Power BI', createdDate: '2025-06-01', resolvedDate: '2025-06-03' },
    { id: 13, status: 'Closed', system: 'glassRUN', createdDate: '2025-06-01', resolvedDate: '2025-06-02' },
    { id: 14, status: 'Closed', system: 'glassRUN', createdDate: '2025-06-02', resolvedDate: '2025-06-04' },
    { id: 15, status: 'Closed', system: 'JDE', createdDate: '2025-06-02', resolvedDate: '2025-06-05' },
    { id: 16, status: 'Ready To Test', system: 'JDE', createdDate: '2025-06-03', resolvedDate: '2025-06-06' },
    { id: 17, status: 'Closed', system: 'Power BI', createdDate: '2025-06-03', resolvedDate: '2025-06-03' },
    { id: 18, status: 'Closed', system: 'DIS', createdDate: '2025-06-04', resolvedDate: '2025-06-07' },
];

// Define a color palette for the systems.
const SYSTEM_COLORS = ['#60a5fa', '#3b82f6', '#1d4ed8', '#1e3a8a', '#ef4444', '#f97316', '#8b5cf6', '#ec4899'];

// Helper function to format dates for the chart axis
const formatDate = (date) => {
    if (!date || isNaN(new Date(date))) return "Invalid Date";
    return new Date(date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
};

// A custom label component for the top of the bars.
const renderCustomizedLabel = (props) => {
    const { x, y, width, value } = props;
    if (value > 0) {
        return (
            <text x={x + width / 2} y={y} dy={-4} fill="#6b7280" fontSize={12} textAnchor="middle">
                {value}
            </text>
        );
    }
    return null;
};


export default function App() {
    const [createdChartData, setCreatedChartData] = useState([]);
    const [resolvedChartData, setResolvedChartData] = useState([]);
    const [comparisonChartData, setComparisonChartData] = useState([]);
    const [totals, setTotals] = useState({ created: 0, resolved: 0, open: 0 });
    const [fileName, setFileName] = useState('');
    const [errorMessage, setErrorMessage] = useState('');
    const [systems, setSystems] = useState([]);
    const [colorMapping, setColorMapping] = useState({});

    useEffect(() => {
        const scriptId = 'papaparse-script';
        if (document.getElementById(scriptId)) return;
        
        const script = document.createElement('script');
        script.id = scriptId;
        script.src = "https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js";
        script.async = true;
        document.body.appendChild(script);

        return () => {
            const scriptElement = document.getElementById(scriptId);
            if (scriptElement) document.body.removeChild(scriptElement);
        };
    }, []);

    // This function processes ticket data to create stats for all three charts.
    const processTicketData = (tickets) => {
        const dailyCreatedStats = {};
        const dailyResolvedStats = {};
        const dailyComparisonStats = {};
        let totalCreated = 0;
        let totalResolved = 0;

        const uniqueSystems = [...new Set(tickets.map(t => t.system).filter(Boolean))];
        const colors = {};
        uniqueSystems.forEach((sys, i) => {
            colors[sys] = SYSTEM_COLORS[i % SYSTEM_COLORS.length];
        });
        setSystems(uniqueSystems);
        setColorMapping(colors);

        const allDates = new Set();
        tickets.forEach(ticket => {
             if (ticket.createdDate) allDates.add(formatDate(new Date(ticket.createdDate)));
             const isResolved = ['Ready To Test', 'Closed'].includes(ticket.status);
             if (isResolved && ticket.resolvedDate) allDates.add(formatDate(new Date(ticket.resolvedDate)));
        });

        allDates.forEach(dateStr => {
            if (dateStr !== "Invalid Date") {
                dailyCreatedStats[dateStr] = { date: dateStr, total: 0 };
                dailyResolvedStats[dateStr] = { date: dateStr, total: 0 };
                dailyComparisonStats[dateStr] = { date: dateStr, Created: 0, Resolved: 0 };
                uniqueSystems.forEach(sys => {
                    dailyCreatedStats[dateStr][sys] = 0;
                    dailyResolvedStats[dateStr][sys] = 0;
                });
            }
        });

        tickets.forEach(ticket => {
            // Process Created Tickets
            if (ticket.createdDate && ticket.system) {
                const createdDateStr = formatDate(new Date(ticket.createdDate));
                if (dailyCreatedStats[createdDateStr]) {
                    dailyCreatedStats[createdDateStr][ticket.system]++;
                    dailyCreatedStats[createdDateStr].total++;
                    dailyComparisonStats[createdDateStr].Created++;
                    totalCreated++;
                }
            }
            
            // Process Resolved Tickets
            const isResolved = ['Ready To Test', 'Closed'].includes(ticket.status);
            if (isResolved && ticket.resolvedDate && ticket.system) {
                const resolvedDateStr = formatDate(new Date(ticket.resolvedDate));
                if (dailyResolvedStats[resolvedDateStr]) {
                   dailyResolvedStats[resolvedDateStr][ticket.system]++;
                   dailyResolvedStats[resolvedDateStr].total++;
                   dailyComparisonStats[resolvedDateStr].Resolved++;
                   totalResolved++;
                }
            }
        });
        
        setCreatedChartData(Object.values(dailyCreatedStats).sort((a, b) => new Date(a.date) - new Date(b.date)));
        setResolvedChartData(Object.values(dailyResolvedStats).sort((a, b) => new Date(a.date) - new Date(b.date)));
        setComparisonChartData(Object.values(dailyComparisonStats).sort((a, b) => new Date(a.date) - new Date(b.date)));
        setTotals({ created: totalCreated, resolved: totalResolved, open: totalCreated - totalResolved });
    };
    
    useEffect(() => {
        const initialDataProcessed = initialTicketData.map(d => ({...d, 'Resolution Time': d.resolvedDate}));
        processTicketData(initialDataProcessed);
    }, []);

    const handleFileChange = (event) => {
        const file = event.target.files[0];
        if (!file) {
             setErrorMessage('No file selected.');
             return;
        }
        
        if (!window.Papa) {
            setErrorMessage('CSV parsing library is still loading. Please try again in a moment.');
            return;
        }

        setFileName(file.name);
        setErrorMessage('');

        window.Papa.parse(file, {
            header: true,
            skipEmptyLines: true,
            complete: (results) => {
                const requiredHeaders = ['ID', 'Status', 'System', 'CreatedDate', 'Resolution Time'];
                const actualHeaders = results.meta.fields;
                const missingHeaders = requiredHeaders.filter(h => !actualHeaders.includes(h));

                if (missingHeaders.length > 0) {
                    setErrorMessage(`CSV is missing required headers: ${missingHeaders.join(', ')}.`);
                    setFileName('');
                    return;
                }
                
                const parsedTickets = results.data.map(row => ({
                    id: row.ID, status: row.Status, system: row.System,
                    createdDate: row.CreatedDate, resolvedDate: row['Resolution Time']
                }));
                processTicketData(parsedTickets);
            },
            error: (error) => setErrorMessage(`Error parsing CSV: ${error.message}`),
        });
    };

    const CustomTooltip = ({ active, payload, label }) => {
        if (active && payload && payload.length) {
            const dataPayload = payload.filter(p => p.value > 0);
            return (
                <div className="p-4 bg-white/90 dark:bg-gray-800/90 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg backdrop-blur-sm">
                    <p className="font-bold text-gray-800 dark:text-gray-100 mb-2">{label}</p>
                    {dataPayload.map((p, i) => (
                         <p key={`payload-${i}`} className="text-sm" style={{ color: p.color }}>{`${p.name}: ${p.value}`}</p>
                    ))}
                </div>
            );
        }
        return null;
    };
    
    const SimpleTooltip = ({ active, payload, label }) => {
        if (active && payload && payload.length) {
            return (
                 <div className="p-4 bg-white/90 dark:bg-gray-800/90 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg backdrop-blur-sm">
                    <p className="font-bold text-gray-800 dark:text-gray-100 mb-2">{label}</p>
                    <p className="text-sm" style={{ color: '#3b82f6' }}>{`Created: ${payload[0].value}`}</p>
                    <p className="text-sm" style={{ color: '#22c55e' }}>{`Resolved: ${payload[1].value}`}</p>
                </div>
            );
        }
        return null;
    }

    return (
        <div className="bg-gray-50 dark:bg-gray-900 min-h-screen p-4 sm:p-6 lg:p-8 font-sans">
            <div className="max-w-full mx-auto">
                <header className="mb-8">
                    <h1 className="text-3xl font-bold text-gray-800 dark:text-white">Ticket Analysis Dashboard</h1>
                    <p className="text-md text-gray-500 dark:text-gray-400 mt-1">Daily Ticket Creation vs. Resolution by System</p>
                </header>

                <div className="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md mb-8">
                    <h2 className="text-lg font-semibold text-gray-700 dark:text-gray-200 mb-4">Upload Your Data</h2>
                    <p className="text-sm text-gray-500 dark:text-gray-400 mb-4">
                        Select a CSV file with 'ID', 'Status', 'System', 'CreatedDate', and 'Resolution Time' columns.
                    </p>
                     <div className="flex items-center gap-4">
                        <label className="cursor-pointer bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg inline-flex items-center transition-colors">
                            <UploadCloud className="mr-2 h-5 w-5" /><input type="file" className="hidden" accept=".csv" onChange={handleFileChange} />
                            <span>{fileName ? "Change File" : "Upload CSV"}</span>
                        </label>
                        {fileName && <span className="text-gray-600 dark:text-gray-300">{fileName}</span>}
                    </div>
                    {errorMessage && (
                        <div className="mt-4 flex items-center text-red-600 dark:text-red-500">
                             <AlertCircle className="mr-2 h-5 w-5" /><span className="text-sm font-medium">{errorMessage}</span>
                        </div>
                    )}
                </div>

                <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                     <div className="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md flex items-center justify-between">
                        <div>
                            <p className="text-sm font-medium text-gray-500 dark:text-gray-400">Total Created</p>
                            <p className="text-3xl font-bold text-gray-800 dark:text-gray-100">{totals.created}</p>
                        </div>
                         <div className="bg-blue-100 dark:bg-blue-900/50 p-3 rounded-full"><FilePlus2 className="h-6 w-6 text-blue-500" /></div>
                    </div>
                     <div className="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md flex items-center justify-between">
                        <div>
                            <p className="text-sm font-medium text-gray-500 dark:text-gray-400">Total Resolved</p>
                            <p className="text-3xl font-bold text-gray-800 dark:text-gray-100">{totals.resolved}</p>
                        </div>
                         <div className="bg-green-100 dark:bg-green-900/50 p-3 rounded-full"><TrendingUp className="h-6 w-6 text-green-500" /></div>
                    </div>
                     <div className="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md flex items-center justify-between">
                        <div>
                            <p className="text-sm font-medium text-gray-500 dark:text-gray-400">Currently Open</p>
                            <p className="text-3xl font-bold text-gray-800 dark:text-gray-100">{totals.open}</p>
                        </div>
                        <div className="bg-orange-100 dark:bg-orange-900/50 p-3 rounded-full">
                            <svg className="h-6 w-6 text-orange-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        </div>
                    </div>
                </div>

                <div className="grid grid-cols-1 xl:grid-cols-3 gap-8">
                    {/* Created Tickets Chart */}
                    <div className="bg-white dark:bg-gray-800 p-4 sm:p-6 rounded-xl shadow-md">
                        <h2 className="text-lg font-semibold text-gray-700 dark:text-gray-200 mb-4">Daily Ticket Creation by System</h2>
                        <div style={{ width: '100%', height: 400 }}>
                            <ResponsiveContainer>
                                <BarChart data={createdChartData} margin={{ top: 20, right: 20, left: -10, bottom: 5 }}>
                                    <CartesianGrid strokeDasharray="3 3" strokeOpacity={0.2} vertical={false} />
                                    <XAxis dataKey="date" tick={{ fill: '#6b7280' }} tickLine={{ stroke: '#6b7280' }} className="text-xs" />
                                    <YAxis allowDecimals={false} tick={{ fill: '#6b7280' }} tickLine={{ stroke: '#6b7280' }} className="text-xs" />
                                    <Tooltip content={<CustomTooltip />} cursor={{ fill: 'rgba(107, 114, 128, 0.1)' }}/>
                                    <Legend wrapperStyle={{paddingTop: '20px'}}/>
                                    {systems.map((sys, index) => (
                                        <Bar key={`created-${sys}`} dataKey={sys} stackId="created" name={sys} fill={colorMapping[sys]}>
                                           {index === systems.length - 1 && (<LabelList dataKey="total" content={renderCustomizedLabel} />)}
                                        </Bar>
                                    ))}
                                </BarChart>
                            </ResponsiveContainer>
                        </div>
                    </div>
                    {/* Resolved Tickets Chart */}
                    <div className="bg-white dark:bg-gray-800 p-4 sm:p-6 rounded-xl shadow-md">
                        <h2 className="text-lg font-semibold text-gray-700 dark:text-gray-200 mb-4">Daily Ticket Resolution by System</h2>
                        <div style={{ width: '100%', height: 400 }}>
                            <ResponsiveContainer>
                                <BarChart data={resolvedChartData} margin={{ top: 20, right: 20, left: -10, bottom: 5 }}>
                                    <CartesianGrid strokeDasharray="3 3" strokeOpacity={0.2} vertical={false} />
                                    <XAxis dataKey="date" tick={{ fill: '#6b7280' }} tickLine={{ stroke: '#6b7280' }} className="text-xs" />
                                    <YAxis allowDecimals={false} tick={{ fill: '#6b7280' }} tickLine={{ stroke: '#6b7280' }} className="text-xs" />
                                    <Tooltip content={<CustomTooltip />} cursor={{ fill: 'rgba(107, 114, 128, 0.1)' }}/>
                                    <Legend wrapperStyle={{paddingTop: '20px'}}/>
                                    {systems.map((sys, index) => (
                                        <Bar key={`resolved-${sys}`} dataKey={sys} stackId="resolved" name={sys} fill={colorMapping[sys]}>
                                             {index === systems.length - 1 && (<LabelList dataKey="total" content={renderCustomizedLabel} />)}
                                        </Bar>
                                    ))}
                                </BarChart>
                            </ResponsiveContainer>
                        </div>
                    </div>
                    {/* Comparison Chart */}
                    <div className="bg-white dark:bg-gray-800 p-4 sm:p-6 rounded-xl shadow-md">
                        <h2 className="text-lg font-semibold text-gray-700 dark:text-gray-200 mb-4">Daily Totals: Created vs. Resolved</h2>
                        <div style={{ width: '100%', height: 400 }}>
                            <ResponsiveContainer>
                                <BarChart data={comparisonChartData} margin={{ top: 20, right: 20, left: -10, bottom: 5 }}>
                                    <CartesianGrid strokeDasharray="3 3" strokeOpacity={0.2} vertical={false} />
                                    <XAxis dataKey="date" tick={{ fill: '#6b7280' }} tickLine={{ stroke: '#6b7280' }} className="text-xs" />
                                    <YAxis allowDecimals={false} tick={{ fill: '#6b7280' }} tickLine={{ stroke: '#6b7280' }} className="text-xs" />
                                    <Tooltip content={<SimpleTooltip />} cursor={{ fill: 'rgba(107, 114, 128, 0.1)' }}/>
                                    <Legend wrapperStyle={{paddingTop: '20px'}}/>
                                    <Bar dataKey="Created" fill="#3b82f6" name="Created" />
                                    <Bar dataKey="Resolved" fill="#22c55e" name="Resolved" />
                                </BarChart>
                            </ResponsiveContainer>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    );
}
