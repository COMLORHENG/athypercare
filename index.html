<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Issue Tracker Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .chart-tooltip {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.75);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
        }
    </style>
</head>
<body class="bg-gray-50">

    <div id="dashboard-content" class="container mx-auto p-4 md:p-8">

        <!-- Header -->
        <header id="main-header" class="bg-white p-6 rounded-2xl shadow-md mb-8 border border-gray-200/50">
            <div class="flex flex-col">
                <div class="flex flex-wrap justify-between items-center gap-4">
                    <h1 class="text-2xl font-bold text-gray-800 text-center md:text-left">Hypercare Incident Analysis Dashboard</h1>
                     <button id="view-all-issues-btn" class="bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors">
                        View All Issues
                    </button>
                </div>
                <div class="flex flex-wrap items-center justify-between gap-4 border-t border-gray-200/80 pt-4 mt-4">
                    <div class="flex items-center gap-4 flex-shrink-0">
                         <p class="text-gray-500 text-sm font-medium">Total Issues</p>
                         <p id="total-issues" class="text-3xl font-bold text-gray-800">0</p>
                    </div>
                    <div id="system-badges-container" class="flex flex-wrap gap-2 justify-center sm:justify-end flex-grow">
                        <!-- Badges for total issues will be inserted here by JS -->
                    </div>
                </div>
                <div id="timestamp-container" class="w-full text-right text-xs text-gray-400 mt-4">
                    <!-- Timestamp will be inserted here by JS -->
                </div>
            </div>
        </header>

        <main id="dashboard-view">
            <!-- Issues by Status Section -->
            <section id="status-summary" class="mb-12">
                <h2 class="text-2xl font-semibold text-gray-700 mb-6">Status Summary</h2>
                <div id="status-cards-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-6">
                   <!-- Status cards will be dynamically inserted here -->
                </div>
            </section>
    
            <!-- Divider -->
            <hr class="my-12 border-gray-200">
    
            <!-- Issues by Department Section -->
            <section id="department-summary" class="mb-12">
                <h2 class="text-2xl font-semibold text-gray-700 mb-6">Department Summary</h2>
                <div id="department-cards-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Department cards will be dynamically inserted here -->
                </div>
            </section>
    
            <!-- Divider -->
            <hr class="my-12 border-gray-200">
    
            <!-- Issues by Priority Section -->
            <section id="priority-summary" class="mb-12">
                <h2 class="text-2xl font-semibold text-gray-700 mb-6">Priority</h2>
                <div id="priority-cards-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                    <!-- Priority cards will be dynamically inserted here -->
                </div>
            </section>
            
            <!-- Divider -->
            <hr class="my-12 border-gray-200">
    
            <!-- Issues by System Section -->
            <section id="system-summary" class="mb-12">
                <h2 class="text-2xl font-semibold text-gray-700 mb-6">System</h2>
                <div id="system-cards-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- System cards will be dynamically inserted here -->
                </div>
            </section>
    
            <!-- Divider -->
            <hr class="my-12 border-gray-200">

            <!-- Issue Category Analysis Section -->
            <section id="issue-category-summary" class="mb-12">
                <h2 class="text-2xl font-semibold text-gray-700 mb-6">Issue Category Analysis</h2>
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <div id="issue-category-chart-container" class="relative"></div>
                    <div id="issue-category-legend-container" class="flex flex-wrap justify-center gap-x-6 gap-y-2 mt-4 pt-4 border-t border-gray-200"></div>
                </div>
            </section>
            
            <!-- Divider -->
            <hr class="my-12 border-gray-200">
            
            <!-- Combined Charts Section -->
            <section id="combined-charts-summary" class="mb-12">
                 <h2 class="text-2xl font-semibold text-gray-700 mb-6">Visual Analysis</h2>
                <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
                    <!-- Issue Reporter Section -->
                    <div class="lg:col-span-1">
                        <div class="bg-white p-6 rounded-xl shadow-md h-full">
                            <h3 class="text-xl font-semibold text-gray-700 mb-4 text-center">Issue Reporter</h3>
                            <div id="reporter-chart-container" class="flex flex-col items-center justify-center gap-8">
                                <!-- Donut chart and legend will be rendered here -->
                            </div>
                         </div>
                    </div>
                    <!-- Tickets by Date Section -->
                    <div class="lg:col-span-1">
                        <div class="bg-white p-6 rounded-xl shadow-md h-full">
                            <h3 class="text-xl font-semibold text-gray-700 mb-4 text-center">Tickets by Date</h3>
                            <div id="tickets-by-date-chart-container" class="relative"></div>
                            <div id="tickets-by-date-legend-container" class="flex flex-wrap justify-center gap-x-6 gap-y-2 mt-4 pt-4 border-t border-gray-200"></div>
                        </div>
                    </div>
                     <!-- Issues by Distributor Section -->
                     <div class="lg:col-span-1">
                         <div class="bg-white p-6 rounded-xl shadow-md h-full">
                            <h3 class="text-xl font-semibold text-gray-700 mb-4 text-center">Distributors</h3>
                            <div id="distributor-chart-container" class="relative overflow-x-auto"></div>
                            <div id="distributor-legend-container" class="flex flex-wrap justify-center gap-x-6 gap-y-2 mt-4 pt-4 border-t border-gray-200"></div>
                        </div>
                    </div>
                </div>
            </section>

             <!-- Upload/Download Buttons Section -->
            <section class="text-center py-8">
                <label for="csv-upload" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-full shadow-lg cursor-pointer hover:bg-blue-700 transition-transform transform hover:scale-105 inline-flex items-center gap-2">
                    <i class="fa-solid fa-upload"></i>
                    <span>Upload New CSV Data</span>
                </label>
                <input type="file" id="csv-upload" class="hidden" accept=".csv">
                
                <button id="generate-pdf-btn" class="bg-green-600 text-white font-bold py-3 px-6 rounded-full shadow-lg cursor-pointer hover:bg-green-700 transition-transform transform hover:scale-105 inline-flex items-center gap-2 ml-4">
                    <i class="fa-solid fa-file-pdf"></i>
                    <span>Generate PDF</span>
                </button>
                <p class="text-xs text-gray-500 mt-3">Uploading a new file will refresh all dashboard visualizations.</p>
            </section>
        </main>

        <div id="issues-list-view" class="hidden">
             <!-- Issue List View will be rendered here -->
        </div>

    </div>

    <script>
        let issueData = [
            { "ID": 12, "Status": "Testing", "Summary": "Data from Power BI vs Print Invoice of JDE system show different", "System": "Power BI", "Description": "Different Unit Price, Discount %, Discount Amount. \n\nNeed Clarify with JDE team to support on this", "Assign To": "Dana Chhun", "Department": "Tax", "Priority": "P2", "Impact": "High", "Urgency": "Medium", "Created By": "Virak Prom", "CreatedDate": "6/4/2025 12:51 PM", "Modified": "6/6/2025 12:04 PM", "Modified By": "Dana Chhun", "Did we test in UAT?": "Yes", "Impacted Distributor": "All Distributors", "Support PIC": "Danish Kokkarani" },
            { "ID": 19, "Status": "Testing", "Summary": "missing data of one distributor ( Everflow )", "System": "Power BI", "Description": "itâ€™s missing data of one distributor ( Everflow ). Due to need enable configuration at backend Data Prime to pull data from BC system.", "Assign To": "Virak Prom", "Department": "OtC", "Priority": "P2", "Impact": "High", "Urgency": "Medium", "Created By": "Virak Prom", "CreatedDate": "6/6/2025 6:44 AM", "Modified": "6/6/2025 11:14 AM", "Modified By": "Virak Prom", "Did we test in UAT?": "Yes", "Impacted Distributor": "EVERFLOW DISTRIBUTOR CO., LTD.", "Support PIC": "Kinneth Chhorn" },
            { "ID": 20, "Status": "Testing", "Summary": "HCAM - Distributor Payment report", "System": "Power BI", "Description": "It need verify and confirm from Owner report", "Assign To": "Sophal Srun", "Department": "OtC", "Priority": "P4", "Impact": "Low", "Urgency": "Low", "Created By": "Virak Prom", "CreatedDate": "6/6/2025 8:29 AM", "Modified": "6/6/2025 8:59 AM", "Modified By": "Virak Prom", "Did we test in UAT?": "Yes", "Impacted Distributor": "All Distributors", "Support PIC": "Pichleakhena Moul" },
            { "ID": 21, "Status": "Testing", "Summary": "HCAM - DIS BI report", "System": "Power BI", "Description": "It need verify and confirm OTC related DIS data from new model", "Assign To": "Sophal Srun", "Department": "OtC", "Priority": "P4", "Impact": "Low", "Urgency": "Low", "Created By": "Virak Prom", "CreatedDate": "6/6/2025 8:33 AM", "Modified": "6/6/2025 8:58 AM", "Modified By": "Virak Prom", "Did we test in UAT?": "Yes", "Impacted Distributor": "All Distributors", "Support PIC": null },
            { "ID": 13, "Status": "Ready To Test", "Summary": "gR in  \" order list view \" not extract excel ", "System": "glassRUN", "Description": "Dear Team, \n\ncurrently, gR in the module \" Order List View \" does not function to extract Excel.\nplease check the attached.\n\nBest Regards,\nReaksa", "Assign To": "Visal Chan", "Department": "Logistic", "Priority": "P3", "Impact": "Medium", "Urgency": "Medium", "Created By": "Reaksa Ban", "CreatedDate": "6/5/2025 10:36 AM", "Modified": "6/6/2025 6:16 AM", "Modified By": "Kimleang Ngoun", "Did we test in UAT?": "Yes", "Impacted Distributor": "All Distributors", "Support PIC": null },
            { "ID": 1, "Status": "Closed", "Summary": "User cannot login to JDE", "System": "JDE", "Description": "When user key in user and password, it show error as incorrect password.", "Assign To": "Visal Chan", "Department": "Finance", "Priority": "P1", "Impact": "High", "Urgency": "High", "Created By": "Sreylin Chum", "CreatedDate": "6/2/2025 9:00 AM", "Modified": "6/2/2025 9:30 AM", "Modified By": "Visal Chan", "Did we test in UAT?": "No", "Impacted Distributor": "All Distributors", "Support PIC": null },
            { "ID": 2, "Status": "Closed", "Summary": "User cannot print invoice", "System": "JDE", "Description": "After user click on print button, nothing come out from printer.", "Assign To": "Visal Chan", "Department": "Finance", "Priority": "P1", "Impact": "High", "Urgency": "High", "Created By": "Sreylin Chum", "CreatedDate": "6/2/2025 9:05 AM", "Modified": "6/2/2025 9:45 AM", "Modified By": "Visal Chan", "Did we test in UAT?": "No", "Impacted Distributor": "All Distributors", "Support PIC": null },
            { "ID": 3, "Status": "Closed", "Summary": "Invoice printed with wrong amount", "System": "JDE", "Description": "The total amount in the invoice is incorrect. It should be $100 but it is $1,000.", "Assign To": "Visal Chan", "Department": "Finance", "Priority": "P1", "Impact": "High", "Urgency": "High", "Created By": "Sreylin Chum", "CreatedDate": "6/2/2025 9:10 AM", "Modified": "6/2/2025 10:00 AM", "Modified By": "Visal Chan", "Did we test in UAT?": "No", "Impacted Distributor": "All Distributors", "Support PIC": null },
            { "ID": 4, "Status": "Closed", "Summary": "System is very slow", "System": "JDE", "Description": "User has to wait for 5 minutes to open a new screen.", "Assign To": "Visal Chan", "Department": "Finance", "Priority": "P2", "Impact": "Medium", "Urgency": "Medium", "Created By": "Sreylin Chum", "CreatedDate": "6/2/2025 9:15 AM", "Modified": "6/2/2025 10:15 AM", "Modified By": "Visal Chan", "Did we test in UAT?": "No", "Impacted Distributor": "All Distributors", "Support PIC": null },
            { "ID": 5, "Status": "Closed", "Summary": "Cannot create new customer", "System": "JDE", "Description": "When user click on \"Create\" button, it show error message \"Invalid customer ID\".", "Assign To": "Visal Chan", "Department": "Finance", "Priority": "P1", "Impact": "High", "Urgency": "High", "Created By": "Sreylin Chum", "CreatedDate": "6/2/2025 9:20 AM", "Modified": "6/2/2025 10:30 AM", "Modified By": "Visal Chan", "Did we test in UAT?": "No", "Impacted Distributor": "All Distributors", "Support PIC": null },
            { "ID": 6, "Status": "In Progress", "Summary": "Data is not updated in Power BI", "System": "Power BI", "Description": "The sales data in Power BI is not showing the latest data from yesterday.", "Assign To": "Danish Kokkarani", "Department": "OtC", "Priority": "P2", "Impact": "High", "Urgency": "Medium", "Created By": "Pichleakhena Moul", "CreatedDate": "6/3/2025 10:00 AM", "Modified": "6/3/2025 10:30 AM", "Modified By": "Danish Kokkarani", "Did we test in UAT?": "Yes", "Impacted Distributor": "All Distributors", "Support PIC": null },
            { "ID": 7, "Status": "In Progress", "Summary": "Cannot access shared folder", "System": "Other", "Description": "User cannot access the shared folder to get the report.", "Assign To": "Visal Chan", "Department": "IT", "Priority": "P3", "Impact": "Medium", "Urgency": "Medium", "Created By": "Pichleakhena Moul", "CreatedDate": "6/3/2025 10:05 AM", "Modified": "6/3/2025 10:45 AM", "Modified By": "Visal Chan", "Did we test in UAT?": "No", "Impacted Distributor": "All Distributors", "Support PIC": null },
            { "ID": 8, "Status": "Open", "Summary": "Request for new report", "System": "Power BI", "Description": "User wants a new report to show sales by product category.", "Assign To": "Danish Kokkarani", "Department": "OtC", "Priority": "P4", "Impact": "Low", "Urgency": "Low", "Created By": "Pichleakhena Moul", "CreatedDate": "6/3/2025 10:10 AM", "Modified": "6/3/2025 11:00 AM", "Modified By": "Danish Kokkarani", "Did we test in UAT?": "Yes", "Impacted Distributor": "All Distributors", "Support PIC": null },
            { "ID": 9, "Status": "Open", "Summary": "Wrong email address in the system", "System": "JDE", "Description": "The email address of customer A is incorrect.", "Assign To": "Visal Chan", "Department": "Finance", "Priority": "P3", "Impact": "Medium", "Urgency": "Medium", "Created By": "Sreylin Chum", "CreatedDate": "6/3/2025 10:15 AM", "Modified": "6/3/2025 11:15 AM", "Modified By": "Visal Chan", "Did we test in UAT?": "No", "Impacted Distributor": "All Distributors", "Support PIC": null },
            { "ID": 10, "Status": "On Hold", "Summary": "Need to clarify the requirement", "System": "Power BI", "Description": "The requirement for the new report is not clear.", "Assign To": "Danish Kokkarani", "Department": "OtC", "Priority": "P4", "Impact": "Low", "Urgency": "Low", "Created By": "Pichleakhena Moul", "CreatedDate": "6/3/2025 10:20 AM", "Modified": "6/3/2025 11:30 AM", "Modified By": "Danish Kokkarani", "Did we test in UAT?": "Yes", "Impacted Distributor": "All Distributors", "Support PIC": null },
            { "ID": 11, "Status": "Canceled", "Summary": "No need this report anymore", "System": "Power BI", "Description": "User has found another report that can be used.", "Assign To": "Danish Kokkarani", "Department": "OtC", "Priority": "P4", "Impact": "Low", "Urgency": "Low", "Created By": "Pichleakhena Moul", "CreatedDate": "6/3/2025 10:25 AM", "Modified": "6/3/2025 11:45 AM", "Modified By": "Danish Kokkarani", "Did we test in UAT?": "Yes", "Impacted Distributor": "All Distributors", "Support PIC": null },
            { "ID": 14, "Status": "In Progress", "Summary": "gR in\" Order Header\" cannot edit", "System": "glassRUN", "Description": "Dear Team, \n\ncurrently, gR in \" Order Header\" cannot edit \nplease check it.\n\nBest Regards,\nReaksa", "Assign To": "Visal Chan", "Department": "Logistic", "Priority": "P3", "Impact": "Medium", "Urgency": "Medium", "Created By": "Reaksa Ban", "CreatedDate": "6/5/2025 10:38 AM", "Modified": "6/5/2025 11:00 AM", "Modified By": "Kimleang Ngoun", "Did we test in UAT?": "Yes", "Impacted Distributor": "All Distributors", "Support PIC": null },
            { "ID": 15, "Status": "In Progress", "summary": "gR in \" order detail \" have some item have not show price.", "System": "glassRUN", "Description": "Dear Team,\n\ncurrently, gR in \" Order detail \" have some item that does not show the price.\nplease check the attached.\n\nBest Regards,\nReaksa", "Assign To": "Visal Chan", "Department": "Logistic", "Priority": "P3", "Impact": "Medium", "Urgency": "Medium", "Created By": "Reaksa Ban", "CreatedDate": "6/5/2025 10:40 AM", "Modified": "6/5/2025 11:05 AM", "Modified By": "Kimleang Ngoun", "Did we test in UAT?": "Yes", "Impacted Distributor": "All Distributors", "Support PIC": null },
            { "ID": 16, "Status": "New", "Summary": "New distributor code from BC not flow to JDE", "System": "JDE", "Description": "New distributor code from BC not flow to JDE", "Assign To": "Sophal Srun", "Department": "Finance", "Priority": "P2", "Impact": "High", "Urgency": "High", "Created By": "Sreylin Chum", "CreatedDate": "6/5/2025 11:00 AM", "Modified": "6/5/2025 11:20 AM", "Modified By": "Sophal Srun", "Did we test in UAT?": "No", "Impacted Distributor": "All Distributors", "Support PIC": "Sophorn Huy" }
        ];

        // --- DATA PROCESSING AND RENDERING ---

        document.addEventListener('DOMContentLoaded', function() {
            // --- SHARED DEFINITIONS ---
            const systemColors = {
                "glassRUN": "#10B981",
                "JDE":      "#3B82F6",
                "DIS":      "#F59E0B",
                "Power BI": "#14B8A6",
                "SEM":      "#D946EF",
                "DOT":      "#8B5CF6",
                "Other":    "#64748B"
            };

            const systemColorClasses = {
                 "glassRUN": "bg-green-50 text-green-700 border border-green-400",
                "JDE":      "bg-blue-50 text-blue-700 border border-blue-400",
                "DIS":      "bg-amber-50 text-amber-700 border border-amber-400",
                "Power BI": "bg-teal-50 text-teal-700 border border-teal-400",
                "SEM":      "bg-fuchsia-50 text-fuchsia-700 border border-fuchsia-400",
                "DOT":      "bg-violet-50 text-violet-700 border border-violet-400",
                "Other":    "bg-slate-50 text-slate-700 border border-slate-400"
            }
            
            const systemStyling = {
                "glassRUN": { icon: "fa-solid fa-layer-group", color: "text-green-500" },
                "JDE":      { icon: "fa-solid fa-database", color: "text-blue-500" },
                "DIS":      { icon: "fa-solid fa-chart-pie", color: "text-amber-500" },
                "Power BI": { icon: "fa-solid fa-chart-simple", color: "text-teal-500" },
                "SEM":      { icon: "fa-solid fa-magnifying-glass-chart", color: "text-fuchsia-500" },
                "DOT":      { icon: "fa-solid fa-circle-nodes", color: "text-violet-500" },
                "Other":    { icon: "fa-solid fa-question-circle", color: "text-slate-500" }
            };

            const statusMap = {
                "New": "Open", "Open": "Open", 
                "In Progress": "Fixing", "Fixing": "Fixing", 
                "On Hold": "Pending", "Pending": "Pending",
                "Ready To Test": "Ready To Test", 
                "Testing": "Testing", 
                "Closed": "Closed", 
                "Canceled": "Closed" 
            };
            
            const statusStyles = {
                "Open":         { order: 1, icon: "fa-solid fa-folder-open",   color: "red" },
                "Fixing":       { order: 2, icon: "fa-solid fa-wrench",        color: "blue" },
                "Pending":      { order: 3, icon: "fa-solid fa-pause",         color: "yellow" },
                "Ready To Test":{ order: 4, icon: "fa-solid fa-flag-checkered",color: "cyan" },
                "Testing":      { order: 5, icon: "fa-solid fa-vial",          color: "teal" },
                "Closed":       { order: 6, icon: "fa-solid fa-circle-check",  color: "green" },
                "Uncategorized": { order: 7, icon: "fa-solid fa-question-circle", color: "gray" }
            };

            const departmentStyling = {
                "Logistic":    { icon: "fa-solid fa-truck-ramp-box", color: "text-orange-500" },
                "OtC":         { icon: "fa-solid fa-file-invoice-dollar", color: "text-green-500" },
                "DMT":         { icon: "fa-solid fa-briefcase", color: "text-purple-500" },
                "Tax":         { icon: "fa-solid fa-landmark", color: "text-amber-500" },
                "RTR":         { icon: "fa-solid fa-chart-line", color: "text-sky-500" },
                "Procurement": { icon: "fa-solid fa-cart-shopping", color: "text-pink-500" },
                "Finance":     { icon: "fa-solid fa-piggy-bank", color: "text-lime-500" },
                "IT":          { icon: "fa-solid fa-desktop", color: "text-indigo-500" },
                "Other":       { icon: "fa-solid fa-building-user", color: "text-slate-500" }
            };

            const priorityStyles = {
                "P1": { name: "Critical", icon: "fa-solid fa-triangle-exclamation", color: "red" },
                "P2": { name: "High",     icon: "fa-solid fa-arrow-up",            color: "orange" },
                "P3": { name: "Medium",   icon: "fa-solid fa-equals",              color: "amber" },
                "P4": { name: "Low",      icon: "fa-solid fa-arrow-down",          color: "sky" }
            };

            function updateAllVisualizations(currentData) {
                renderStickyHeader(currentData);
                renderStatusSummary(currentData);
                renderDepartmentSummary(currentData);
                renderPrioritySummary(currentData);
                renderSystemSummary(currentData);
                renderDistributorChart(currentData);
                renderReporterChart(currentData);
                renderTicketsByDateChart(currentData);
                renderIssueCategoryChart(currentData);
            }

            // --- RENDER STICKY HEADER ---
            function renderStickyHeader(data) {
                document.getElementById('total-issues').textContent = data.length;
                const totalSystemCounts = data.reduce((acc, issue) => {
                    const systemKey = systemColorClasses.hasOwnProperty(issue.System) ? issue.System : "Other";
                    acc[systemKey] = (acc[systemKey] || 0) + 1;
                    return acc;
                }, {});
                const totalBadgeContainer = document.getElementById('system-badges-container');
                totalBadgeContainer.innerHTML = '';
                Object.keys(totalSystemCounts).sort().forEach(system => {
                    totalBadgeContainer.innerHTML += `<span class="${systemColorClasses[system]} text-xs font-semibold px-2.5 py-1 rounded-full">${system}: ${totalSystemCounts[system]}</span>`;
                });
                const timestampContainer = document.getElementById('timestamp-container');
                timestampContainer.textContent = `Report generated: ${new Date().toLocaleString()}`;
            }

            // --- RENDER STATUS SUMMARY SECTION ---
            function renderStatusSummary(data) {
                const statusCounts = data.reduce((acc, issue) => {
                    const mappedStatus = statusMap[issue.Status] || "Uncategorized";
                    acc[mappedStatus] = (acc[mappedStatus] || 0) + 1;
                    return acc;
                }, {});

                const container = document.getElementById('status-cards-container');
                container.innerHTML = '';
                Object.keys(statusCounts).sort((a, b) => (statusStyles[a]?.order || 99) - (statusStyles[b]?.order || 99))
                .forEach(status => {
                    const count = statusCounts[status];
                    const style = statusStyles[status] || statusStyles["Uncategorized"];
                    const issuesInStatus = data.filter(issue => (statusMap[issue.Status] || "Uncategorized") === status);
                    const systemCountsInStatus = issuesInStatus.reduce((acc, issue) => {
                        const systemKey = systemColorClasses.hasOwnProperty(issue.System) ? issue.System : "Other";
                        acc[systemKey] = (acc[systemKey] || 0) + 1;
                        return acc;
                    }, {});
                    let badgesHTML = '';
                    Object.keys(systemCountsInStatus).sort().forEach(system => {
                        badgesHTML += `<span class="${systemColorClasses[system]} text-xs font-semibold px-2.5 py-1 rounded-full">${system}: ${systemCountsInStatus[system]}</span>`;
                    });
                    container.innerHTML += `
                        <div class="bg-white p-4 rounded-xl shadow-md flex flex-col justify-between border-l-4 border-${style.color}-500 h-full">
                           <div>
                                <div class="flex items-center justify-between mb-4">
                                     <h3 class="font-bold text-gray-800">${status}</h3>
                                     <div class="bg-${style.color}-100 rounded-full p-2">
                                        <i class="${style.icon} text-${style.color}-500 text-lg fa-fw"></i>
                                    </div>
                                </div>
                                <p class="text-4xl font-bold text-gray-800">${count}</p>
                           </div>
                           <div class="flex flex-wrap gap-1 mt-4">
                                ${badgesHTML}
                           </div>
                        </div>
                    `;
                });
            }

            // --- RENDER DEPARTMENT SUMMARY SECTION ---
            function renderDepartmentSummary(data) {
                const departmentData = data.reduce((acc, issue) => {
                    const dept = issue.Department;
                     if (!dept) return acc;
                    if (!acc[dept]) acc[dept] = [];
                    acc[dept].push(issue);
                    return acc;
                }, {});
                
                const container = document.getElementById('department-cards-container');
                container.innerHTML = '';
                Object.keys(departmentData).sort().forEach(deptName => {
                    const issuesInDept = departmentData[deptName];
                    const total = issuesInDept.length;
                    const style = departmentStyling[deptName] || departmentStyling["Other"];
                    const statuses = issuesInDept.reduce((acc, issue) => {
                        const mappedStatus = statusMap[issue.Status] || "Uncategorized";
                        acc[mappedStatus] = (acc[mappedStatus] || 0) + 1;
                        return acc;
                    }, {});
                    const systems = issuesInDept.reduce((acc, issue) => {
                         const systemKey = systemColorClasses.hasOwnProperty(issue.System) ? issue.System : "Other";
                         acc[systemKey] = (acc[systemKey] || 0) + 1;
                         return acc;
                    }, {});
                    let systemBadgesHTML = '<div class="flex flex-wrap gap-2 mt-4">';
                     Object.keys(systems).sort().forEach(system => {
                        systemBadgesHTML += `<span class="${systemColorClasses[system]} text-xs font-semibold px-2.5 py-1 rounded-full">${system}: ${systems[system]}</span>`;
                    });
                    systemBadgesHTML += '</div>';
                    let statusHTML = '<div class="space-y-2 mt-4 pt-4 border-t border-gray-100">';
                    const sortedStatuses = Object.keys(statuses).sort((a,b) => (statusStyles[a]?.order || 99) - (statusStyles[b]?.order || 99));
                    sortedStatuses.forEach(statusName => {
                        const count = statuses[statusName];
                        const statusStyle = statusStyles[statusName] || statusStyles['Default'];
                        statusHTML += `
                            <div class="flex items-center justify-between text-sm">
                                <div class="flex items-center">
                                    <span class="h-2 w-2 rounded-full bg-${statusStyle.color}-500 mr-2"></span>
                                    <span>${statusName}</span>
                                </div>
                                <span class="font-semibold text-gray-700">${count}</span>
                            </div>
                        `;
                    });
                    statusHTML += '</div>';
                    container.innerHTML += `
                        <div class="bg-white p-6 rounded-xl shadow-md w-80 flex-shrink-0 flex flex-col">
                           <div class="flex-grow">
                                <div class="flex justify-between items-start">
                                    <div class="flex items-center gap-3">
                                        <i class="${style.icon} ${style.color} text-xl fa-fw"></i>
                                        <h3 class="font-bold text-gray-800">${deptName}</h3>
                                    </div>
                                    <span class="bg-gray-200 text-gray-800 text-sm font-bold px-2.5 py-1 rounded-full">${total}</span>
                                </div>
                                ${total > 0 ? systemBadgesHTML : ''}
                            </div>
                            <div class="mt-auto">
                                ${total > 0 ? statusHTML : '<p class="text-sm text-gray-400 mt-4">No issues reported.</p>'}
                            </div>
                        </div>
                    `;
                });
            }

            // --- RENDER PRIORITY SUMMARY SECTION ---
            function renderPrioritySummary(data) {
                const priorityGroups = data.reduce((acc, issue) => {
                    const priority = issue.Priority;
                    if (!priority) return acc;
                    if (!acc[priority]) acc[priority] = [];
                    acc[priority].push(issue);
                    return acc;
                }, {});
                const container = document.getElementById('priority-cards-container');
                container.innerHTML = '';
                Object.keys(priorityStyles).forEach(priorityKey => {
                    const issues = priorityGroups[priorityKey] || [];
                    const style = priorityStyles[priorityKey];
                    const total = issues.length;
                    const systemCounts = issues.reduce((acc, issue) => {
                        acc[issue.System] = (acc[issue.System] || 0) + 1;
                        return acc;
                    }, {});
                    let systemsHTML = '';
                     Object.keys(systemCounts).sort().forEach(sys => {
                        systemsHTML += `<span class="${systemColorClasses[sys] || systemColorClasses['Other']} text-xs font-semibold px-2 py-1 rounded-full">${sys} (${systemCounts[sys]})</span>`;
                    });
                    const deptCounts = issues.reduce((acc, issue) => {
                        acc[issue.Department] = (acc[issue.Department] || 0) + 1;
                        return acc;
                    }, {});
                    let deptsHTML = '';
                    Object.keys(deptCounts).sort().forEach(dept => {
                        deptsHTML += `<span class="bg-gray-100 text-gray-800 text-xs font-semibold px-2 py-1 rounded-full">${dept} (${deptCounts[dept]})</span>`;
                    });
                    const statusCounts = issues.reduce((acc, issue) => {
                        const mappedStatus = statusMap[issue.Status] || "Uncategorized";
                        acc[mappedStatus] = (acc[mappedStatus] || 0) + 1;
                        return acc;
                    }, {});
                    let statusHTML = '<div class="space-y-2 mt-4 pt-4 border-t border-gray-200">';
                    const sortedStatuses = Object.keys(statusCounts).sort((a,b) => (statusStyles[a]?.order || 99) - (statusStyles[b]?.order || 99));
                    sortedStatuses.forEach(statusName => {
                        const count = statusCounts[statusName];
                        const statusStyle = statusStyles[statusName] || statusStyles['Default'];
                        statusHTML += `
                            <div class="flex items-center justify-between text-sm">
                                <div class="flex items-center">
                                    <span class="h-2 w-2 rounded-full bg-${statusStyle.color}-500 mr-2"></span>
                                    <span>${statusName}</span>
                                </div>
                                <span class="font-semibold text-gray-700">${count}</span>
                            </div>
                        `;
                    });
                    statusHTML += '</div>';
                    container.innerHTML += `
                        <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-${style.color}-500">
                            <div class="flex items-center justify-between">
                                <h3 class="font-bold text-gray-800">${priorityKey} - ${style.name}</h3>
                                <i class="${style.icon} text-${style.color}-500 text-2xl"></i>
                            </div>
                            <p class="text-4xl font-bold text-gray-800 mt-4">${total}</p>
                            <div class="mt-4 space-y-3">
                                <div>
                                    <h4 class="text-sm font-semibold text-gray-500 mb-2">Systems</h4>
                                    <div class="flex flex-wrap gap-2">${systemsHTML}</div>
                                </div>
                                <div>
                                    <h4 class="text-sm font-semibold text-gray-500 mb-2">Departments</h4>
                                    <div class="flex flex-wrap gap-2">${deptsHTML}</div>
                                </div>
                            </div>
                            ${total > 0 ? statusHTML : ''}
                        </div>
                    `;
                });
            }

             // --- RENDER SYSTEM SUMMARY SECTION ---
            function renderSystemSummary(data) {
                const systemGroups = data.reduce((acc, issue) => {
                    const system = issue.System;
                    if (!system) return acc;
                    const systemKey = systemColorClasses.hasOwnProperty(system) ? system : "Other";
                    if (!acc[systemKey]) acc[systemKey] = [];
                    acc[systemKey].push(issue);
                    return acc;
                }, {});

                const container = document.getElementById('system-cards-container');
                container.innerHTML = '';

                Object.keys(systemGroups).sort().forEach(systemName => {
                    const issuesInSystem = systemGroups[systemName] || [];
                    const total = issuesInSystem.length;
                    const style = systemStyling[systemName];

                    const statusCounts = issuesInSystem.reduce((acc, issue) => {
                        const mappedStatus = statusMap[issue.Status] || "Uncategorized";
                        acc[mappedStatus] = (acc[mappedStatus] || 0) + 1;
                        return acc;
                    }, {});
                    let statusHTML = '<div class="space-y-2 mt-4 pt-4 border-t border-gray-100">';
                    const sortedStatuses = Object.keys(statusCounts).sort((a,b) => (statusStyles[a]?.order || 99) - (statusStyles[b]?.order || 99));
                    sortedStatuses.forEach(statusName => {
                        const count = statusCounts[statusName];
                        const statusStyle = statusStyles[statusName] || statusStyles['Default'];
                        statusHTML += `
                            <div class="flex items-center justify-between text-sm">
                                <div class="flex items-center">
                                    <span class="h-2 w-2 rounded-full bg-${statusStyle.color}-500 mr-2"></span>
                                    <span>${statusName}</span>
                                </div>
                                <span class="font-semibold text-gray-700">${count}</span>
                            </div>`;
                    });
                    statusHTML += '</div>';

                    const priorityCounts = issuesInSystem.reduce((acc, issue) => {
                        if(issue.Priority) acc[issue.Priority] = (acc[issue.Priority] || 0) + 1;
                        return acc;
                    }, {});
                    let priorityHTML = '<div class="mt-4 pt-4 border-t border-gray-100"><h4 class="text-sm font-semibold text-gray-500 mb-2">Priority Breakdown</h4><div class="flex flex-wrap gap-2">';
                    Object.keys(priorityStyles).forEach(priorityKey => {
                        if (priorityCounts[priorityKey]) {
                            priorityHTML += `<span class="bg-${priorityStyles[priorityKey].color}-100 text-${priorityStyles[priorityKey].color}-800 text-xs font-semibold px-2 py-1 rounded-full">${priorityKey} (${priorityCounts[priorityKey]})</span>`;
                        }
                    });
                    priorityHTML += '</div></div>';

                    container.innerHTML += `
                        <div class="bg-white p-6 rounded-xl shadow-md">
                            <div class="flex justify-between items-start">
                                <div class="flex items-center gap-3">
                                    <i class="${style.icon} ${style.color} text-xl fa-fw"></i>
                                    <h3 class="font-bold text-gray-800">${systemName}</h3>
                                </div>
                                <span class="bg-gray-200 text-gray-800 text-sm font-bold px-2.5 py-1 rounded-full">${total}</span>
                            </div>
                             ${total > 0 ? priorityHTML : ''}
                            ${total > 0 ? statusHTML : '<p class="text-sm text-gray-400 mt-4">No issues reported.</p>'}
                        </div>
                    `;
                });
            }
            
             // --- RENDER DISTRIBUTOR CHART ---
            function renderDistributorChart(data) {
                const container = d3.select("#distributor-chart-container");
                container.html("");

                const tooltip = d3.select("body").append("div")
                    .attr("class", "chart-tooltip");

                const distributorData = d3.group(data, d => d["Impacted Distributor"]);
                
                const processedData = Array.from(distributorData, ([distributor, issues]) => {
                    if (distributor === null || distributor === '') return null;
                    const systemCounts = d3.rollup(issues, v => v.length, d => {
                        return systemColors.hasOwnProperty(d.System) ? d.System : "Other";
                    });
                    const systems = Array.from(systemCounts, ([system, count]) => ({ system, count }));
                    const total = d3.sum(systems, d => d.count);
                    return { distributor, systems, total };
                }).filter(Boolean).sort((a, b) => b.total - a.total);

                const systems = Object.keys(systemColors);
                const margin = {top: 20, right: 40, bottom: 40, left: 250};
                const parentWidth = container.node().getBoundingClientRect().width;
                const width = parentWidth > 0 ? parentWidth - margin.left - margin.right : 500;
                const height = processedData.length * 50;

                const svg = container.append("svg")
                    .attr("viewBox", `0 0 ${width + margin.left + margin.right} ${height + margin.top + margin.bottom}`)
                    .append("g")
                    .attr("transform", `translate(${margin.left},${margin.top})`);
                
                const y = d3.scaleBand()
                    .domain(processedData.map(d => d.distributor))
                    .range([0, height])
                    .padding(0.3);

                const x = d3.scaleLinear()
                    .domain([0, d3.max(processedData, d => d.total) || 1])
                    .range([0, width]);

                const color = d3.scaleOrdinal()
                    .domain(systems)
                    .range(Object.values(systemColors));

                const stack = d3.stack()
                    .keys(systems)
                    .value((d, key) => {
                        const systemData = d.systems.find(s => s.system === key);
                        return systemData ? systemData.count : 0;
                    });
                
                const series = stack(processedData);
                
                svg.append("g")
                    .selectAll("g")
                    .data(series)
                    .join("g")
                        .attr("fill", d => color(d.key))
                    .selectAll("rect")
                    .data(d => d)
                    .join("rect")
                        .attr("y", d => y(d.data.distributor))
                        .attr("x", d => x(d[0]))
                        .attr("width", d => x(d[1]) - x(d[0]))
                        .attr("height", y.bandwidth())
                        .on("mouseover", (event, d) => {
                            const systemName = d3.select(event.currentTarget.parentNode).datum().key;
                            const count = d[1] - d[0];
                            tooltip.style("opacity", 1)
                                .html(`<b>${d.data.distributor}</b><br>${systemName}: ${count}`)
                                .style("left", (event.pageX + 10) + "px")
                                .style("top", (event.pageY - 28) + "px");
                        })
                        .on("mouseout", () => tooltip.style("opacity", 0));
                
                 svg.append("g")
                    .selectAll("g")
                    .data(series)
                    .join("g")
                    .selectAll("text")
                    .data(d => d)
                    .join("text")
                    .text(d => {
                        const value = d[1] - d[0];
                        return value > 0 ? value : "";
                    })
                    .attr("x", d => x(d[0]) + (x(d[1]) - x(d[0])) / 2)
                    .attr("y", d => y(d.data.distributor) + y.bandwidth() / 2)
                    .attr("dy", "0.35em")
                    .attr("text-anchor", "middle")
                    .attr("fill", "white")
                    .attr("font-size", "12px")
                    .attr("font-weight", "500");

                svg.append("g")
                    .selectAll("text")
                    .data(processedData)
                    .join("text")
                    .text(d => d.total)
                    .attr("x", d => x(d.total) + 8)
                    .attr("y", d => y(d.distributor) + y.bandwidth() / 2)
                    .attr("dy", "0.35em")
                    .attr("fill", "#1f2937")
                    .attr("font-size", "14px")
                    .attr("font-weight", "600");

                svg.append("g")
                    .call(d3.axisLeft(y).tickSize(0))
                    .select(".domain").remove();
                
                const legendContainer = document.getElementById('distributor-legend-container');
                legendContainer.innerHTML = ''; 
                systems.forEach(system => {
                    const colorValue = systemColors[system];
                    const legendItem = document.createElement('div');
                    legendItem.className = 'flex items-center';
                    legendItem.innerHTML = `
                        <div class="w-4 h-4 rounded-sm mr-2" style="background-color: ${colorValue}"></div>
                        <span class="text-sm text-gray-600">${system}</span>
                    `;
                    legendContainer.appendChild(legendItem);
                });
            }

            // --- RENDER REPORTER DONUT CHART ---
            function renderReporterChart(data) {
                const container = d3.select("#reporter-chart-container");
                container.html(""); 

                const tooltip = d3.select("body").append("div")
                    .attr("class", "chart-tooltip");
                
                const reporterData = d3.group(data, d => d["Created By"]);
                const processedData = Array.from(reporterData, ([reporter, issues]) => ({
                    name: reporter,
                    count: issues.length
                })).sort((a,b) => b.count - a.count);

                const totalIssuesInChart = d3.sum(processedData, d => d.count);

                const width = 300, height = 300, margin = 20;
                const radius = Math.min(width, height) / 2 - margin;
                
                const svg = container.append("div").attr("class", "relative")
                    .append("svg")
                    .attr("width", width)
                    .attr("height", height)
                    .append("g")
                    .attr("transform", `translate(${width/2},${height/2})`);
                
                const color = d3.scaleOrdinal(d3.schemeTableau10);

                const pie = d3.pie()
                    .value(d => d.count)
                    .sort(null);

                const arc = d3.arc()
                    .innerRadius(radius * 0.6)
                    .outerRadius(radius);
                
                const arcs = pie(processedData);

                svg.selectAll('path')
                    .data(arcs)
                    .join('path')
                    .attr('d', arc)
                    .attr('fill', (d, i) => color(i))
                    .attr('stroke', 'white')
                    .style('stroke-width', '2px')
                    .on("mouseover", (event, d) => {
                        tooltip.style("opacity", 1)
                            .html(`<b>${d.data.name}</b><br>${d.data.count} issues (${((d.data.count / totalIssuesInChart) * 100).toFixed(1)}%)`)
                            .style("left", (event.pageX + 10) + "px")
                            .style("top", (event.pageY - 28) + "px");
                        d3.select(event.currentTarget).transition().duration(200).attr('transform', `scale(1.05)`);
                    })
                    .on("mouseout", (event, d) => {
                        tooltip.style("opacity", 0);
                        d3.select(event.currentTarget).transition().duration(200).attr('transform', `scale(1)`);
                    });

                svg.selectAll('text.slice-label')
                    .data(arcs)
                    .join('text')
                    .attr('class', 'slice-label')
                    .attr('transform', d => `translate(${arc.centroid(d)})`)
                    .attr('text-anchor', 'middle')
                    .attr('dy', '0.35em')
                    .style('fill', 'white')
                    .style('font-size', '12px')
                    .style('font-weight', 'bold')
                    .text(d => `${((d.data.count / totalIssuesInChart) * 100).toFixed(0)}%`);

                 svg.append('text')
                    .attr('text-anchor', 'middle')
                    .attr('dy', '-0.5em')
                    .style('font-size', '2.5rem')
                    .style('font-weight', 'bold')
                    .style('fill', '#1f2937')
                    .text(totalIssuesInChart);
                 svg.append('text')
                    .attr('text-anchor', 'middle')
                    .attr('dy', '1em')
                    .style('font-size', '0.9rem')
                    .style('fill', '#6b7280')
                    .text('Total Issues');

                const legendContainer = container.append('div')
                    .attr('class', 'grid grid-cols-2 gap-x-6 gap-y-3');
                
                processedData.forEach((d, i) => {
                    const legendItem = document.createElement('div');
                    legendItem.className = 'flex items-center';
                    legendItem.innerHTML = `
                        <div class="w-4 h-4 rounded-sm mr-2" style="background-color: ${color(i)}"></div>
                        <span class="text-sm text-gray-700">${d.name} (${d.count})</span>
                    `;
                    legendContainer.node().appendChild(legendItem);
                });
            }
            
            // --- RENDER TICKETS BY DATE CHART ---
            function renderTicketsByDateChart(data) {
                const container = d3.select("#tickets-by-date-chart-container");
                container.html("");

                const tooltip = d3.select("body").append("div")
                    .attr("class", "chart-tooltip");
                
                const parseDate = d3.timeParse("%m/%d/%Y %I:%M %p");
                
                const dataByDate = d3.group(data, d => d3.timeFormat("%Y-%m-%d")(parseDate(d.CreatedDate)));
                
                const processedData = Array.from(dataByDate, ([date, issues]) => {
                    const systemCounts = d3.rollup(issues, v => v.length, d => {
                        return systemColors.hasOwnProperty(d.System) ? d.System : "Other";
                    });
                    const systems = Array.from(systemCounts, ([system, count]) => ({ system, count }));
                    const total = d3.sum(systems, d => d.count);
                    return { date: new Date(date), systems, total };
                }).sort((a,b) => a.date - b.date);

                const systems = Object.keys(systemColors);
                
                const margin = {top: 30, right: 30, bottom: 40, left: 40};
                const parentWidth = container.node().getBoundingClientRect().width;
                const width = parentWidth > 0 ? parentWidth - margin.left - margin.right : 700;
                const height = 400 - margin.top - margin.bottom;

                const svg = container.append("svg")
                    .attr("viewBox", `0 0 ${width + margin.left + margin.right} ${height + margin.top + margin.bottom}`)
                    .append("g")
                    .attr("transform", `translate(${margin.left},${margin.top})`);
                
                const x = d3.scaleBand()
                    .domain(processedData.map(d => d.date))
                    .range([0, width])
                    .padding(0.2);

                const y = d3.scaleLinear()
                    .domain([0, d3.max(processedData, d => d.total) || 1])
                    .range([height, 0]);

                const color = d3.scaleOrdinal()
                    .domain(systems)
                    .range(Object.values(systemColors));
                
                const stack = d3.stack()
                    .keys(systems)
                    .value((d, key) => {
                        const systemData = d.systems.find(s => s.system === key);
                        return systemData ? systemData.count : 0;
                    });
                
                const series = stack(processedData);

                svg.append("g")
                    .selectAll("g")
                    .data(series)
                    .join("g")
                        .attr("fill", d => color(d.key))
                    .selectAll("rect")
                    .data(d => d)
                    .join("rect")
                        .attr("x", d => x(d.data.date))
                        .attr("y", d => y(d[1]))
                        .attr("height", d => y(d[0]) - y(d[1]))
                        .attr("width", x.bandwidth())
                        .on("mouseover", (event, d) => {
                            const systemName = d3.select(event.currentTarget.parentNode).datum().key;
                            const count = d[1] - d[0];
                            tooltip.style("opacity", 1)
                                .html(`<b>${d3.timeFormat("%b %d, %Y")(d.data.date)}</b><br>${systemName}: ${count}`)
                                .style("left", (event.pageX + 10) + "px")
                                .style("top", (event.pageY - 28) + "px");
                        })
                        .on("mouseout", () => tooltip.style("opacity", 0));
                
                // Add system counts inside bars
                 svg.append("g")
                    .selectAll("g")
                    .data(series)
                    .join("g")
                    .selectAll("text")
                    .data(d => d)
                    .join("text")
                    .text(d => {
                        const value = d[1] - d[0];
                        return value > 0 ? value : "";
                    })
                    .attr("x", d => x(d.data.date) + x.bandwidth() / 2)
                    .attr("y", d => y(d[1]) + (y(d[0]) - y(d[1])) / 2)
                    .attr("dy", "0.35em")
                    .attr("text-anchor", "middle")
                    .attr("fill", "white")
                    .attr("font-size", "12px")
                    .attr("font-weight", "500");

                // Add total counts above bars
                svg.append("g")
                    .selectAll("text")
                    .data(processedData)
                    .join("text")
                    .text(d => d.total)
                    .attr("x", d => x(d.date) + x.bandwidth() / 2)
                    .attr("y", d => y(d.total) - 5)
                    .attr("text-anchor", "middle")
                    .attr("fill", "#374151")
                    .attr("font-size", "12px")
                    .attr("font-weight", "bold");
                
                svg.append("g")
                    .attr("transform", `translate(0,${height})`)
                    .call(d3.axisBottom(x).tickFormat(d3.timeFormat("%b %d")));
                
                svg.append("g")
                    .call(d3.axisLeft(y).ticks(5).tickSize(0))
                    .select(".domain").remove();

                const legendContainer = document.getElementById('tickets-by-date-legend-container');
                legendContainer.innerHTML = '';
                systems.forEach(system => {
                    const colorValue = systemColors[system];
                    const legendItem = document.createElement('div');
                    legendItem.className = 'flex items-center';
                    legendItem.innerHTML = `
                        <div class="w-4 h-4 rounded-sm mr-2" style="background-color: ${colorValue}"></div>
                        <span class="text-sm text-gray-600">${system}</span>
                    `;
                    legendContainer.appendChild(legendItem);
                });
            }

             // --- RENDER ISSUE CATEGORY ANALYSIS CHART ---
            function renderIssueCategoryChart(data) {
                const container = d3.select("#issue-category-chart-container");
                container.html("");

                const tooltip = d3.select("body").append("div")
                    .attr("class", "chart-tooltip");

                const categoryData = d3.group(data, d => d["Issue Category"], d => d.System);
                
                const processedData = Array.from(categoryData, ([category, systems]) => {
                     if (!category) return null;
                    const systemCounts = Array.from(systems, ([system, issues]) => ({ system, count: issues.length }));
                    const total = d3.sum(systemCounts, d => d.count);
                    return { category, systems: systemCounts, total };
                }).filter(Boolean).sort((a,b) => b.total - a.total);

                const allSystems = [...new Set(data.map(d => d.System).filter(Boolean))];

                const margin = {top: 20, right: 40, bottom: 40, left: 250};
                const parentWidth = container.node().getBoundingClientRect().width;
                const width = parentWidth > 0 ? parentWidth - margin.left - margin.right : 700;
                const height = processedData.length * 50;

                const svg = container.append("svg")
                    .attr("viewBox", `0 0 ${width + margin.left + margin.right} ${height + margin.top + margin.bottom}`)
                    .append("g")
                    .attr("transform", `translate(${margin.left},${margin.top})`);

                const y = d3.scaleBand()
                    .domain(processedData.map(d => d.category))
                    .range([0, height])
                    .padding(0.3);

                const x = d3.scaleLinear()
                    .domain([0, d3.max(processedData, d => d.total) || 1])
                    .range([0, width]);
                
                const color = d3.scaleOrdinal(d3.schemePaired).domain(allSystems);

                const stack = d3.stack()
                    .keys(allSystems)
                    .value((d, key) => {
                        const systemData = d.systems.find(sys => sys.system === key);
                        return systemData ? systemData.count : 0;
                    });

                const series = stack(processedData);

                svg.append("g")
                    .selectAll("g")
                    .data(series)
                    .join("g")
                        .attr("fill", d => color(d.key))
                    .selectAll("rect")
                    .data(d => d)
                    .join("rect")
                        .attr("y", d => y(d.data.category))
                        .attr("x", d => x(d[0]))
                        .attr("width", d => x(d[1]) - x(d[0]))
                        .attr("height", y.bandwidth())
                        .on("mouseover", (event, d) => {
                            const systemName = d3.select(event.currentTarget.parentNode).datum().key;
                            const count = d[1] - d[0];
                            tooltip.style("opacity", 1)
                                .html(`<b>${d.data.category}</b><br>${systemName}: ${count}`)
                                .style("left", (event.pageX + 10) + "px")
                                .style("top", (event.pageY - 28) + "px");
                        })
                        .on("mouseout", () => tooltip.style("opacity", 0));
                        
                svg.append("g")
                    .selectAll("g")
                    .data(series)
                    .join("g")
                    .selectAll("text")
                    .data(d => d)
                    .join("text")
                    .text(d => {
                        const value = d[1] - d[0];
                        const percentage = (value / d.data.total) * 100;
                        return percentage > 5 ? `${percentage.toFixed(0)}%` : "";
                    })
                    .attr("x", d => x(d[0]) + (x(d[1]) - x(d[0])) / 2)
                    .attr("y", d => y(d.data.category) + y.bandwidth() / 2)
                    .attr("dy", "0.35em")
                    .attr("text-anchor", "middle")
                    .attr("fill", "white")
                    .attr("font-size", "12px")
                    .attr("font-weight", "500");

                svg.append("g")
                    .selectAll("text")
                    .data(processedData)
                    .join("text")
                    .text(d => d.total)
                    .attr("x", d => x(d.total) + 8)
                    .attr("y", d => y(d.category) + y.bandwidth() / 2)
                    .attr("dy", "0.35em")
                    .attr("fill", "#1f2937")
                    .attr("font-size", "14px")
                    .attr("font-weight", "bold");

                svg.append("g")
                    .call(d3.axisLeft(y).tickSize(0))
                    .select(".domain").remove();

                const legendContainer = document.getElementById('issue-category-legend-container');
                legendContainer.innerHTML = '';
                allSystems.forEach(system => {
                    const colorValue = color(system);
                    const legendItem = document.createElement('div');
                    legendItem.className = 'flex items-center';
                    legendItem.innerHTML = `
                        <div class="w-4 h-4 rounded-sm mr-2" style="background-color: ${colorValue}"></div>
                        <span class="text-sm text-gray-600">${system}</span>
                    `;
                    legendContainer.appendChild(legendItem);
                });

            }


            // --- INITIALIZE DASHBOARD & UPLOAD ---
            updateAllVisualizations(issueData);

            document.getElementById('csv-upload').addEventListener('change', event => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const csvText = e.target.result;
                            const newData = d3.csvParse(csvText);
                            if(newData.length === 0 || !newData[0].hasOwnProperty('ID')){
                                alert('Invalid CSV format. Please ensure the file has the correct headers.');
                                return;
                            }
                            issueData = newData;
                            updateAllVisualizations(issueData);
                        } catch (error) {
                            console.error("Error parsing CSV:", error);
                            alert("Failed to parse the CSV file. Please check the file format and try again.");
                        }
                    };
                    reader.onerror = () => alert("Error reading the file.");
                    reader.readAsText(file);
                }
            });

            document.getElementById('generate-pdf-btn').addEventListener('click', () => {
                const { jsPDF } = window.jspdf;
                const content = document.getElementById('dashboard-content');
                
                html2canvas(content, { scale: 2, windowWidth: content.scrollWidth, windowHeight: content.scrollHeight }).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = pdf.internal.pageSize.getHeight();
                    const canvasWidth = canvas.width;
                    const canvasHeight = canvas.height;
                    const ratio = canvasHeight / canvasWidth;
                    let imgHeight = pdfWidth * ratio;
                    let heightLeft = imgHeight;
                    let position = 0;

                    pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, imgHeight);
                    heightLeft -= pdfHeight;

                    while (heightLeft > 0) {
                        position = heightLeft - imgHeight;
                        pdf.addPage();
                        pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, imgHeight);
                        heightLeft -= pdfHeight;
                    }
                    pdf.save('dashboard-report.pdf');
                });
            });
        });
    </script>
</body>
</html>
